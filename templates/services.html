{% extends "base.html" %}

{% block title %}Services - Swagger API Viewer{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Services</h2>
    <div>
      <a href="{{ url_for('upload') }}" class="btn btn-primary me-2">
        <i class="bi bi-upload me-1"></i> Upload Specs
      </a>
      <a href="{{ url_for('endpoints') }}" class="btn btn-outline-secondary">
        <i class="bi bi-list-ul me-1"></i> Endpoints
      </a>
    </div>
  </div>

  {% if not services %}
  <div class="alert alert-info">
    No services found. Upload your OpenAPI/Swagger files on the Upload page.
  </div>
  {% else %}
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th style="min-width: 220px;">Service</th>
          <th>Filename</th>
          <th>Version</th>
          <th>Base Path / Server URL</th>
          <th class="text-end">Endpoints</th>
          <th>Last Modified</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for svc in services %}
        <tr>
          <td>
            <strong>{{ svc.name }}</strong>
          </td>
          <td><code>{{ svc.filename }}</code></td>
          <td>{{ svc.version or '-' }}</td>
          <td><code>{{ svc.base_path or '-' }}</code></td>
          <td class="text-end">
            <span class="badge bg-dark">{{ svc.endpoints }}</span>
          </td>
          <td>
            {% if svc.modified_at %}
              {{ svc.modified_at | datetimeformat }}
            {% else %}
              <span class="text-muted">Unknown</span>
            {% endif %}
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-primary generate-service-btn"
                    data-service-filename="{{ svc.filename }}"
                    data-service-name="{{ svc.name }}"
                    title="Generate Test Files">
              <i class="bi bi-gear"></i> Generate
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
function handleGenerateServiceClick(e) {
  e.preventDefault();
  const btn = e.currentTarget;
  const filename = btn.getAttribute('data-service-filename');
  const svcName = btn.getAttribute('data-service-name') || filename;
  if (!filename) return;

  const originalHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';

  fetch('/api/generate_test_scripts', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
    body: JSON.stringify({
      type: 'service',
      service: filename,
      scenario_name: filename.split('.')[0]  // Use filename without extension as scenario name
    })
  })
  .then(r => {
    if (!r.ok) return r.json().then(j => { throw j; });
    return r.json();
  })
  .then(data => {
    const toast = new bootstrap.Toast(document.getElementById('successToast'));
    const toastBody = document.querySelector('#successToast .toast-body');
    const fileList = (data.files || []).map(f => '<li>' + (f.split('/').pop()) + '</li>').join('');
    var html = '<div>' +
      '<p>Test files for "' + svcName + '" have been generated successfully.</p>' +
      '<p class="mb-1">Saved to: <code>' + (data.output_dir || '') + '</code></p>' +
      '<div class="mt-2">' +
        '<button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#svcFileList">Show generated files</button>' +
        '<div class="collapse mt-2" id="svcFileList">' +
          '<div class="card card-body bg-dark text-white p-2">' +
            '<ul class="mb-0">' + fileList + '</ul>' +
          '</div>' +
        '</div>' +
      '</div>' +
    '</div>';
    if (toastBody) { toastBody.innerHTML = html; toast.show(); }
  })
  .catch(err => {
    const toast = new bootstrap.Toast(document.getElementById('errorToast'));
    const toastBody = document.querySelector('#errorToast .toast-body');
    const msg = (err && (err.error || err.message)) || 'Failed to generate test files';
    if (toastBody) { toastBody.textContent = msg; toast.show(); }
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = originalHtml;
  });
}

  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(el){ return new bootstrap.Tooltip(el); });

    document.querySelectorAll('.generate-service-btn').forEach(function(btn){
      btn.addEventListener('click', handleGenerateServiceClick);
    });
  });
</script>
<!-- Toast containers -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
  <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
{% endblock %}
